{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Demandas</title>
    <link rel="stylesheet" href="{% static 'styles/main.css' %}">
    <link rel="stylesheet" href="{% static 'styles/header.css' %}">
</head>

<body>
    <header>
        <div class="logo">
            <img class="img-hc img-hx" src="{% static 'src/logo-hc-ufpe.png' %}" alt="Logo HC-UFPE">
            <img class="img-ebserch" src="{% static 'src/logo-ebserh.png' %}" alt="Logo Ebserh">
        </div>
        <nav class="navegacao">
            <a href="{% url 'landing' %}">Início</a>
            <a href="{% url 'sobre_nos' %}">Sobre nós</a>
            <a href="{% url 'home' %}">Serviços</a>
            <a href="{% url 'demandas' %}">Demandas</a>
            <a href="#">Hub</a>
            {% if user.is_authenticated %}
            <span class="usuario-logado">Olá, {{ user.get_full_name|default:user.username }}</span>
            <form id="logout-form" method="post" action="{% url 'accounts:logout' %}" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="next" value="{% url 'landing' %}">
                <button type="submit" id="btn-logout" class="botao-entrar" style="background:none;border:none;color:inherit;cursor:pointer;">Sair</button>
            </form>
            {% else %}
            <a href="{% url 'accounts:login' %}" class="botao-entrar">Entrar</a>
            {% endif %}
        </nav>
    </header>
    <main>
        <h1>Demandas</h1>
        <button id="btn-nova">Nova Demanda</button>

        <form id="form-nova" method="post" action="{% url 'demandas' %}" style="display:none; margin-top:16px;">
            {% csrf_token %}
            <div>
                <label>Título</label>
                <input type="text" name="title" required />
            </div>
            <div>
                <label>Descrição</label>
                <textarea name="description" rows="4" required></textarea>
            </div>
            <div>
                <label>Status</label>
                <select name="status" required>
                    <option value="recebida">Recebida</option>
                    <option value="analise">Em análise</option>
                    <option value="andamento">Em andamento</option>
                    <option value="concluida">Concluída</option>
                </select>
            </div>
            <button type="submit">Salvar</button>
        </form>

        <hr />

        <table border="1" cellpadding="6" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th>Autor</th>
                    <th>Título</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for d in demands %}
                <tr class="linha-demanda" data-descricao="{{ d.description|escapejs }}">
                    <td>
                        {{ d.author.get_full_name|default:d.author.name|default:d.author.username|default:d.author.email|default:d.author_name|default:"-" }}
                    </td>
                    <td>{{ d.title }}</td>
                    <td>{{ d.get_status_display }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="3">Nenhuma demanda cadastrada.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Popup -->
        <div id="popup" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%); background:#fff; border:1px solid #333; padding:16px; max-width:500px;">
            <h3 id="popup-titulo"></h3>
            <p id="popup-descricao"></p>
            <button id="popup-fechar">Fechar</button>
        </div>

        <script>
            document.getElementById("btn-nova").addEventListener("click", () => {
                const f = document.getElementById("form-nova");
                f.style.display = f.style.display === "none" ? "block" : "none";
            });

            document.querySelectorAll(".linha-demanda").forEach(row => {
                row.addEventListener("click", () => {
                    document.getElementById("popup-titulo").textContent = row.children[1].textContent;
                    document.getElementById("popup-descricao").textContent = row.dataset.descricao;
                    document.getElementById("popup").style.display = "block";
                });
            });

            document.getElementById("popup-fechar").addEventListener("click", () => {
                document.getElementById("popup").style.display = "none";
            });
        </script>
    </main>
    <footer>
        <p>&copy; HC-UFPE</p>
    </footer>
</body>

</html>