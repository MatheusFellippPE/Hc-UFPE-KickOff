{% load static %}
{% load demands_extras %}
<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Hub</title>
    <link rel="stylesheet" href="{% static 'styles/main.css' %}">
    <link rel="stylesheet" href="{% static 'styles/header.css' %}">
    <link rel="stylesheet" href="{% static 'styles/hub.css' %}">
</head>

<body>
    <header>
        <div class="logo">
            <img class="img-hc img-hx" src="{% static 'src/logo-hc-ufpe.png' %}" alt="Logo HC-UFPE">
            <img class="img-ebserch" src="{% static 'src/logo-ebserh.png' %}" alt="Logo Ebserh">
        </div>
        <nav class="navegacao">
            <a href="{% url 'landing' %}">In칤cio</a>
            <a href="{% url 'sobre_nos' %}">Sobre n칩s</a>
            <a href="{% url 'home' %}">Servi칞os</a>
            <a href="{% url 'demandas' %}">Demandas</a>
            <a href="{% url 'hub' %}">Hub</a>
            {% if user.is_authenticated %}
            <form method="post" action="{% url 'accounts:logout' %}" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.path }}" />
                <button type="submit" class="botao-entrar" style="background:none;border:none;cursor:pointer;">Sair</button>
            </form>
            {% else %}
            <a href="{% url 'accounts:login' %}?next={{ request.path|urlencode }}" class="botao-entrar">Entrar</a>
            {% endif %}
        </nav>
    </header>
    <main>
        <div class="header-secun">
            <!-- <h1>Hub de Inova칞칚o</h1> -->
            <!-- bot칚o novo post -->
            <button id="novo-post-btn">Novo post</button>
        </div>

        <!-- formul치rio oculto que envia para a mesma view hub_forum -->
        <form id="novo-post-form" action="{% url 'hub' %}" method="post" enctype="multipart/form-data" style="display:none; margin-top:1rem;">
            {% csrf_token %}
            <input type="hidden" name="post_type" id="post_type" value="texto">
            <div class="post-type-tabs">
                <button type="button" data-type="texto" class="active">Texto</button>
                <button type="button" data-type="multimidia">Multimidia</button>
                <button type="button" data-type="link">Link</button>
            </div>

            <div class="form-section input-titulo">
                <input type="text" id="title" name="title" maxlength="200" placeholder="T칤tulo" required>
            </div>

            <div class="form-section seletor-tags">
                <label>Tags</label>
                <div class="tags-box">
                    {% for tag in tags %}
                    <label class="tag-option">
                        <input type="checkbox" name="tags" value="{{ tag.name }}">
                        <span>{{ tag.name }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <div class="form-section input-texto">
                <textarea id="body" name="body" placeholder="Escreva aqui..."></textarea>
            </div>

            <div class="form-section input-media" style="display:none;">
                <label for="media">Fotos/V칤deos</label>
                <input id="media" name="media" type="file" multiple accept="image/*,video/*">
            </div>

            <div class="form-section input-link" style="display:none;">
                <input type="url" id="link_url" name="link_url" placeholder="https://">
            </div>

            <div class="actions">
                <button class="btn-draft" type="submit" name="action" value="draft">Salvar rascunho</button>
                <button class="btn-publish" type="submit" name="action" value="publish">Postar</button>
                <button class="btn-cancelar" type="button" id="cancel-btn" style="background:#aaa;">Cancelar</button>
            </div>
        </form>

        <!-- lista de posts -->
        <section id="posts">
            {% for post in posts %}
            <div class="post-wrapper" data-post-id="{{ post.id }}">
                <article class="post" data-post-id="{{ post.id }}">
                    <h2>{{ post.title }}</h2>
                    <p class="meta">por {% if post.author %}{{ post.author.first_name|default:post.author.username }}{% else %}An칪nimo{% endif %} - {{ post.created_at }}</p>
                    <div class="tags">
                        {% for t in post.tags.all %}
                        <span class="tag">{{ t.name }}</span>
                        {% endfor %}
                    </div>
                    <div class="body">{{ post.body|linebreaks }}</div>
                    <!-- Bloco de coment치rios movido para logo ap칩s o corpo -->
                    <div class="comments" id="comments-{{ post.id }}" style="margin-top:0.75rem;">
                        {% for c in post.comments.all %}
                            <div class="comment-item"><strong>{{ c.author_name }}</strong>: {{ c.body|linebreaksbr }}</div>
                        {% empty %}
                            <div class="comment-empty">Sem coment치rios.</div>
                        {% endfor %}
                    </div>
                </article>
                <div class="post-reactions" data-post-id="{{ post.id }}">
                    {% if user.is_authenticated %}
                    {% with user_reactions|get_item:post.id as my_reaction %}
                    <button class="like-btn {% if my_reaction == 1 %}active{% endif %}" data-value="1">游녨 <span class="like-count">{{ post.likes_count }}</span></button>
                    <button class="dislike-btn {% if my_reaction == -1 %}active{% endif %}" data-value="-1">游녩 <span class="dislike-count">{{ post.dislikes_count }}</span></button>
                    <button class="comment-btn" data-action="comment" title="Comentar">Comentar</button>
                    {% endwith %}
                    {% else %}
                    <span>游녨 {{ post.likes_count }} | 游녩 {{ post.dislikes_count }} (fa칞a login para reagir)</span>
                    {% endif %}
                </div>
                {% if user.is_authenticated %}
                <div class="comment-form" id="comment-form-{{ post.id }}" style="display:none; margin-top:0.5rem;">
                    <form>
                        <textarea name="body" rows="3" style="width:100%;" placeholder="Seu coment치rio..."></textarea>
                        <div>
                            <button type="button" class="comment-send" data-post-id="{{ post.id }}">Enviar</button>
                            <button type="button" class="comment-cancel" data-post-id="{{ post.id }}">Cancelar</button>
                        </div>
                    </form>
                </div>
                {% endif %}
            </div>
            {% empty %}
            <p>Sem posts ainda.</p>
            {% endfor %}
        </section>

    </main>
    <footer>
        <p>&copy; HC-UFPE</p>
    </footer>

    <script>
        // JS m칤nimo para mostrar/ocultar o formul치rio sem trabalhar o front-end
        const novoBtn = document.getElementById('novo-post-btn');
        const form = document.getElementById('novo-post-form');
        const cancelBtn = document.getElementById('cancel-btn');
        novoBtn.addEventListener('click', () => form.style.display = 'block');
        cancelBtn.addEventListener('click', () => form.style.display = 'none');

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
        const csrftoken = getCookie('csrftoken');

        document.querySelectorAll('.post-reactions').forEach(bar => {
            const postId = bar.getAttribute('data-post-id');
            bar.querySelectorAll('.like-btn, .dislike-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const value = btn.getAttribute('data-value');
                    fetch(`/hub/react/${postId}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': csrftoken,
                        },
                        body: `value=${value}`
                    }).then(r => r.json()).then(data => {
                        bar.querySelector('.like-count').textContent = data.likes;
                        bar.querySelector('.dislike-count').textContent = data.dislikes;
                        bar.querySelectorAll('.like-btn, .dislike-btn').forEach(b => b.classList.remove('active'));
                        if (data.current === 1) {
                            bar.querySelector('.like-btn').classList.add('active');
                        } else if (data.current === -1) {
                            bar.querySelector('.dislike-btn').classList.add('active');
                        }
                    }).catch(err => console.error(err));
                });
            });
            const commentBtn = bar.querySelector('.comment-btn');
            if (commentBtn) {
                // Substitui alerta antigo por exibir formul치rio de coment치rio
                commentBtn.addEventListener('click', () => {
                    const form = document.getElementById('comment-form-' + postId);
                    if (form) form.style.display = 'block';
                });
            }
        });

        // Controle de abas tipo de post (removido uso de 'separators')
        const postTypeInput = document.getElementById('post_type');
        const tabs = document.querySelectorAll('.post-type-tabs button');
        const mediaField = document.querySelector('.input-media');
        const linkField = document.querySelector('.input-link');

        function setType(t) {
            postTypeInput.value = t;
            tabs.forEach(b => b.classList.toggle('active', b.dataset.type === t));
            mediaField.style.display = (t === 'multimidia') ? 'block' : 'none';
            linkField.style.display = (t === 'link') ? 'block' : 'none';
        }
        tabs.forEach(b => b.addEventListener('click', () => setType(b.dataset.type)));

        // Galeria: limitar a 3 imagens e aplicar layout (1, 2 ou 3)
        document.querySelectorAll('.post .media').forEach(container => {
            const items = Array.from(container.querySelectorAll('.media-item.is-image'));
            if (items.length === 0) return;

            // ativar galeria
            container.classList.add('gallery');

            // esconder imagens al칠m da 3춹
            items.forEach((it, idx) => {
                if (idx >= 3) it.style.display = 'none';
            });

            // definir layout pela quantidade (1, 2 ou 3)
            const count = Math.min(items.length, 3);
            container.classList.add(`layout-${count}`);
        });

        document.querySelectorAll('.comment-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const postId = btn.closest('.post-wrapper').getAttribute('data-post-id');
                const form = document.getElementById('comment-form-' + postId);
                if (form) form.style.display = 'block';
            });
        });

        document.querySelectorAll('.comment-cancel').forEach(btn => {
            btn.addEventListener('click', () => {
                const postId = btn.getAttribute('data-post-id');
                const form = document.getElementById('comment-form-' + postId);
                if (form) form.style.display = 'none';
            });
        });

        document.querySelectorAll('.comment-send').forEach(btn => {
            btn.addEventListener('click', () => {
                const postId = btn.getAttribute('data-post-id');
                const form = document.getElementById('comment-form-' + postId);
                const textarea = form.querySelector('textarea[name="body"]');
                const body = textarea.value.trim();
                if (!body) return;
                fetch(`/hub/comment/${postId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrftoken,
                    },
                    body: `body=${encodeURIComponent(body)}`
                }).then(r => r.json()).then(data => {
                    const list = document.getElementById('comments-' + postId);
                    const empty = list.querySelector('.comment-empty');
                    if (empty) empty.remove();
                    const div = document.createElement('div');
                    div.className = 'comment-item';
                    div.innerHTML = `<strong>${data.author}</strong>: ${data.body}`;
                    list.appendChild(div);
                    textarea.value='';
                    form.style.display='none';
                }).catch(err => console.error(err));
            });
        });
    </script>
</body>

</html>