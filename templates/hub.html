{% load static %}
{% load demands_extras %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Hub</title>
    <link rel="stylesheet" href="{% static 'styles/main.css' %}">
    <link rel="stylesheet" href="{% static 'styles/header.css' %}">
</head>
<body>
<header>
    <div class="logo">
        <img class="img-hc img-hx" src="{% static 'src/logo-hc-ufpe.png' %}" alt="Logo HC-UFPE">
        <img class="img-ebserch" src="{% static 'src/logo-ebserh.png' %}" alt="Logo Ebserh">
    </div>
    <nav class="navegacao">
        <a href="{% url 'landing' %}">In칤cio</a>
        <a href="{% url 'sobre_nos' %}">Sobre n칩s</a>
        <a href="{% url 'home' %}">Servi칞os</a>
        <a href="{% url 'demandas' %}">Demandas</a>
        <a href="{% url 'hub' %}">Hub</a>
        {% if user.is_authenticated %}
            <form method="post" action="{% url 'accounts:logout' %}" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.path }}" />
                <button type="submit" class="botao-entrar" style="background:none;border:none;cursor:pointer;">Sair ({{ user.first_name|default:user.username }})</button>
            </form>
        {% else %}
            <a href="{% url 'accounts:login' %}?next={{ request.path|urlencode }}" class="botao-entrar">Entrar</a>
        {% endif %}
    </nav>
</header>
<main>
    <h1>Hub de Inova칞칚o</h1>

    <!-- bot칚o novo post -->
    <button id="novo-post-btn">Novo post</button>

    <!-- formul치rio oculto que envia para a mesma view hub_forum -->
    <form id="novo-post-form" action="{% url 'hub' %}" method="post" enctype="multipart/form-data" style="display:none; margin-top:1rem;">
        {% csrf_token %}
        <div>
            <label for="title">T칤tulo</label>
            <input type="text" id="title" name="title" maxlength="200" required>
        </div>
        <div>
            <label for="tags">Tags (segure Ctrl/Cmd para multisele칞칚o)</label>
            <select id="tags" name="tags" multiple>
                {% for tag in tags %}
                    <option value="{{ tag.name }}">{{ tag.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="body">Texto</label>
            <textarea id="body" name="body" rows="6" required></textarea>
        </div>
        <div>
            <label for="media">Fotos/V칤deos (v치rios permitidos)</label>
            <input id="media" name="media" type="file" multiple accept="image/*,video/*">
        </div>
        <div>
            <button type="submit">Enviar</button>
            <button type="button" id="cancel-btn">Cancelar</button>
        </div>
    </form>

    <!-- lista de posts -->
    <section id="posts">
        {% for post in posts %}
            <article class="post" data-post-id="{{ post.id }}">
                <h2>{{ post.title }}</h2>
                <p class="meta">por {% if post.author %}{{ post.author.first_name|default:post.author.username }}{% else %}An칪nimo{% endif %} - {{ post.created_at }}</p>
                <div class="tags">
                    {% for t in post.tags.all %}
                        <span class="tag">{{ t.name }}</span>
                    {% endfor %}
                </div>
                <div class="body">{{ post.body|linebreaks }}</div>
                <div class="media">
                    {% for m in post.media.all %}
                        {% if m.file.url %}
                            <div class="media-item">
                                {% if m.file.url|slice:"-4:" in ".jpg.png.gif.jpeg.webm.mp4" %}
                                    <img src="{{ m.file.url }}" alt="media" style="max-width:300px;">
                                {% else %}
                                    <a href="{{ m.file.url }}">Download</a>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
                <div class="reactions">
                    {% if user.is_authenticated %}
                        {% with user_reactions|get_item:post.id as my_reaction %}
                        <button class="like-btn {% if my_reaction == 1 %}active{% endif %}" data-value="1">游녨 <span class="like-count">{{ post.likes_count }}</span></button>
                        <button class="dislike-btn {% if my_reaction == -1 %}active{% endif %}" data-value="-1">游녩 <span class="dislike-count">{{ post.dislikes_count }}</span></button>
                        {% endwith %}
                    {% else %}
                        <span>游녨 {{ post.likes_count }} | 游녩 {{ post.dislikes_count }} (fa칞a login para reagir)</span>
                    {% endif %}
                </div>
            </article>
        {% empty %}
            <p>Sem posts ainda.</p>
        {% endfor %}
    </section>

</main>
<footer>
    <p>&copy; HC-UFPE</p>
</footer>

<script>
    // JS m칤nimo para mostrar/ocultar o formul치rio sem trabalhar o front-end
    const novoBtn = document.getElementById('novo-post-btn');
    const form = document.getElementById('novo-post-form');
    const cancelBtn = document.getElementById('cancel-btn');
    novoBtn.addEventListener('click', () => form.style.display = 'block');
    cancelBtn.addEventListener('click', () => form.style.display = 'none');

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }
    const csrftoken = getCookie('csrftoken');

    document.querySelectorAll('.post').forEach(postEl => {
        const postId = postEl.getAttribute('data-post-id');
        postEl.querySelectorAll('.like-btn, .dislike-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const value = btn.getAttribute('data-value');
                fetch(`/hub/react/${postId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrftoken,
                    },
                    body: `value=${value}`
                }).then(r => r.json()).then(data => {
                    postEl.querySelector('.like-count').textContent = data.likes;
                    postEl.querySelector('.dislike-count').textContent = data.dislikes;
                    // atualizar classes active
                    postEl.querySelectorAll('.like-btn, .dislike-btn').forEach(b => b.classList.remove('active'));
                    if (data.current === 1) {
                        postEl.querySelector('.like-btn').classList.add('active');
                    } else if (data.current === -1) {
                        postEl.querySelector('.dislike-btn').classList.add('active');
                    }
                }).catch(err => console.error(err));
            });
        });
    });
</script>
</body>
</html>
